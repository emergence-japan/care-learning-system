generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String   @id @default(cuid())
  name          String
  loginId       String   @unique  // ログイン用の独自ID
  password      String
  role          Role     @default(STAFF)
  facilityId    String?
  corporationId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  facility      Facility? @relation(fields: [facilityId], references: [id])
  corporation   Corporation? @relation(fields: [corporationId], references: [id])
  enrollments   Enrollment[]
  inquiries     Inquiry[]
}

model Inquiry {
  id            String   @id @default(cuid())
  subject       String
  content       String
  senderId      String
  status        InquiryStatus @default(UNREAD)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  sender        User     @relation(fields: [senderId], references: [id])
  replies       InquiryReply[]
}

model InquiryReply {
  id            String   @id @default(cuid())
  inquiryId     String
  content       String
  senderId      String
  createdAt     DateTime @default(now())
  inquiry       Inquiry  @relation(fields: [inquiryId], references: [id])
}

enum InquiryStatus {
  UNREAD
  READ
  REPLIED
  CLOSED
}

model Facility {
  id            String   @id @default(cuid())
  name          String   @unique
  type          String?  // 業態
  corporationId String?
  maxStaff      Int      @default(20)   // 施設ごとのスタッフ上限
  isActive      Boolean  @default(true)  // ステータス管理
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  corporation   Corporation? @relation(fields: [corporationId], references: [id])
  users         User[]
  assignments   CourseAssignment[]
}

model Corporation {
  id         String   @id @default(cuid())
  name       String   @unique
  fiscalYearStartMonth Int @default(4) // 年度開始月 (1-12)
  maxFacilities Int     @default(10)  // 最大施設数
  maxStaff      Int     @default(100) // 最大スタッフ数
  isActive      Boolean  @default(true)  // ステータス管理
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  facilities Facility[]
  users      User[]
}

enum Role {
  SUPER_ADMIN
  HQ
  ADMIN
  STAFF
}

model Course {
  id          String   @id @default(cuid())
  slug        String   @unique  // 管理用識別コード (abuse, dementia, etc.)
  title       String
  description String?
  introduction String?   // 注意喚起（導入）
  learningObjectives String? // 学習目標
  videoUrl    String?
  badgeLabel  String?   // バッジ用短縮名
  badgeIcon   String?   // バッジ用アイコンID (Shield, Zap, etc.)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  enrollments Enrollment[]
  questions   Question[]
  slides      Slide[]
  assignments CourseAssignment[]
}

model CourseAssignment {
  id          String   @id @default(cuid())
  facilityId  String
  courseId    String
  startDate   DateTime @default(now())
  endDate     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  facility    Facility @relation(fields: [facilityId], references: [id])
  course      Course   @relation(fields: [courseId], references: [id])
  @@unique([facilityId, courseId])
}

model Slide {
  id        String   @id @default(cuid())
  courseId  String
  title     String
  content   String   // HTMLコンテンツ
  videoUrl  String?  // 補助動画URL
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  course    Course   @relation(fields: [courseId], references: [id])
}

model Question {
  id        String   @id @default(cuid())
  courseId  String
  text      String
  explanation String?  // 解説文
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  course    Course   @relation(fields: [courseId], references: [id])
  choices   Choice[]
}

model Choice {
  id         String   @id @default(cuid())
  questionId String
  text       String
  isCorrect  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  question   Question @relation(fields: [questionId], references: [id])
}

model Enrollment {
  id        String    @id @default(cuid())
  userId    String
  courseId  String
  status    Status    @default(NOT_STARTED)
  actionPlan String?   // 行動宣言
  completedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user   User   @relation(fields: [userId], references: [id])
  course Course @relation(fields: [courseId], references: [id])
  @@unique([userId, courseId])
}

enum Status {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}
